syntax = "proto3";

package payment_method.v1;

option go_package = "github.com/kevin07696/payment-service/proto/payment_method/v1;paymentmethodv1";

import "google/protobuf/timestamp.proto";

// PaymentMethodType represents the type of payment method
enum PaymentMethodType {
  PAYMENT_METHOD_TYPE_UNSPECIFIED = 0;
  PAYMENT_METHOD_TYPE_CREDIT_CARD = 1;
  PAYMENT_METHOD_TYPE_ACH = 2;
}

// PaymentMethodService handles saved payment method operations
service PaymentMethodService {
  // GetPaymentMethod retrieves a specific payment method
  rpc GetPaymentMethod(GetPaymentMethodRequest) returns (PaymentMethod) {
  }

  // ListPaymentMethods lists all payment methods for a customer
  rpc ListPaymentMethods(ListPaymentMethodsRequest) returns (ListPaymentMethodsResponse) {
  }

  // UpdatePaymentMethodStatus updates the active status of a payment method
  rpc UpdatePaymentMethodStatus(UpdatePaymentMethodStatusRequest) returns (PaymentMethodResponse) {
  }

  // DeletePaymentMethod soft deletes a payment method (sets deleted_at)
  rpc DeletePaymentMethod(DeletePaymentMethodRequest) returns (DeletePaymentMethodResponse) {
  }

  // SetDefaultPaymentMethod marks a payment method as default
  rpc SetDefaultPaymentMethod(SetDefaultPaymentMethodRequest) returns (PaymentMethodResponse) {
  }

  // VerifyACHAccount sends pre-note for ACH verification
  rpc VerifyACHAccount(VerifyACHAccountRequest) returns (VerifyACHAccountResponse) {
  }

  // StoreACHAccount creates ACH Storage BRIC and sends pre-note for verification
  // Use case: Customer adds bank account for recurring payments
  rpc StoreACHAccount(StoreACHAccountRequest) returns (PaymentMethodResponse) {
  }

  // UpdatePaymentMethod updates metadata only (billing info, nickname)
  // Does NOT support changing account/routing numbers - create new payment method instead
  rpc UpdatePaymentMethod(UpdatePaymentMethodRequest) returns (PaymentMethodResponse) {
  }
}

// GetPaymentMethodRequest retrieves a payment method
message GetPaymentMethodRequest {
  string payment_method_id = 1; // UUID
}

// ListPaymentMethodsRequest lists payment methods
message ListPaymentMethodsRequest {
  string merchant_id = 1;
  string customer_id = 2;
  optional PaymentMethodType payment_type = 3; // Optional: filter by type
  optional bool is_active = 4; // Optional: filter by active status
}

// ListPaymentMethodsResponse contains payment method list
message ListPaymentMethodsResponse {
  repeated PaymentMethod payment_methods = 1;
}

// UpdatePaymentMethodStatusRequest updates payment method status
message UpdatePaymentMethodStatusRequest {
  string payment_method_id = 1;
  string merchant_id = 2;
  string customer_id = 3;
  bool is_active = 4; // true = activate, false = deactivate
}

// DeletePaymentMethodRequest soft deletes a payment method
message DeletePaymentMethodRequest {
  string payment_method_id = 1;
  string idempotency_key = 2;
}

// DeletePaymentMethodResponse confirms deletion
message DeletePaymentMethodResponse {
  bool success = 1;
  string message = 2;
}

// SetDefaultPaymentMethodRequest sets default payment method
message SetDefaultPaymentMethodRequest {
  string payment_method_id = 1;
  string merchant_id = 2;
  string customer_id = 3;
}

// VerifyACHAccountRequest initiates ACH verification
message VerifyACHAccountRequest {
  string payment_method_id = 1; // ACH payment method to verify
  string merchant_id = 2;
  string customer_id = 3;
}

// VerifyACHAccountResponse contains verification status
message VerifyACHAccountResponse {
  string payment_method_id = 1;
  string transaction_id = 2; // Pre-note transaction ID
  string status = 3; // "pending", "verified", "failed"
  string message = 4;
}

// AccountType for ACH accounts
enum AccountType {
  ACCOUNT_TYPE_UNSPECIFIED = 0;
  ACCOUNT_TYPE_CHECKING = 1;
  ACCOUNT_TYPE_SAVINGS = 2;
}

// StdEntryClass for ACH transactions
enum StdEntryClass {
  STD_ENTRY_CLASS_UNSPECIFIED = 0;
  STD_ENTRY_CLASS_PPD = 1; // Prearranged Payment and Deposit (personal)
  STD_ENTRY_CLASS_CCD = 2; // Corporate Credit or Debit
  STD_ENTRY_CLASS_WEB = 3; // Internet-initiated entry
  STD_ENTRY_CLASS_TEL = 4; // Telephone-initiated entry
}

// StoreACHAccountRequest creates ACH Storage BRIC
message StoreACHAccountRequest {
  string merchant_id = 1;
  string customer_id = 2;

  // Raw ACH account details (backend receives from customer)
  string account_number = 3;
  string routing_number = 4;
  string account_holder_name = 5;
  AccountType account_type = 6; // CHECKING or SAVINGS
  StdEntryClass std_entry_class = 7; // PPD, CCD, WEB, TEL

  // Billing information (optional but recommended)
  optional string first_name = 8;
  optional string last_name = 9;
  optional string address = 10;
  optional string city = 11;
  optional string state = 12;
  optional string zip_code = 13;

  // Display metadata (optional)
  optional string bank_name = 14; // "Chase", "Bank of America"
  optional string nickname = 15; // "Primary checking", "Business account"

  bool is_default = 16;
  string idempotency_key = 17;
}

// UpdatePaymentMethodRequest updates metadata only
// Does NOT support changing account/routing numbers, card numbers, etc.
// For account changes, delete old payment method and create new one
message UpdatePaymentMethodRequest {
  string payment_method_id = 1;
  string merchant_id = 2;
  string customer_id = 3;

  // Metadata updates (all optional)
  optional string billing_name = 4;
  optional string billing_address = 5;
  optional string billing_city = 6;
  optional string billing_state = 7;
  optional string billing_zip = 8;
  optional string nickname = 9;
  optional bool is_default = 10;

  string idempotency_key = 11;
}

// PaymentMethodResponse is returned from payment method operations
message PaymentMethodResponse {
  string payment_method_id = 1;
  string merchant_id = 2;
  string customer_id = 3;
  PaymentMethodType payment_type = 4;

  // Display metadata
  string last_four = 5;

  // Credit card specific
  optional string card_brand = 6;
  optional int32 card_exp_month = 7;
  optional int32 card_exp_year = 8;

  // ACH specific
  optional string bank_name = 9;
  optional string account_type = 10;

  // Status
  bool is_default = 11;
  bool is_active = 12;
  bool is_verified = 13; // For ACH pre-note verification

  google.protobuf.Timestamp created_at = 14;
  google.protobuf.Timestamp last_used_at = 15;
}

// PaymentMethod represents a complete payment method record
message PaymentMethod {
  string id = 1;
  string merchant_id = 2;
  string customer_id = 3;
  PaymentMethodType payment_type = 4;

  // Display metadata (NEVER include full card/account numbers)
  string last_four = 5;

  // Credit card specific
  optional string card_brand = 6;
  optional int32 card_exp_month = 7;
  optional int32 card_exp_year = 8;

  // ACH specific
  optional string bank_name = 9;
  optional string account_type = 10;

  // Status
  bool is_default = 11;
  bool is_active = 12;
  bool is_verified = 13;

  google.protobuf.Timestamp created_at = 14;
  google.protobuf.Timestamp updated_at = 15;
  google.protobuf.Timestamp last_used_at = 16;
}
