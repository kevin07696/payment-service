name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Allow other workflows to trigger based on this workflow's completion
# Used by staging-lifecycle.yml to auto-destroy/create staging
permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    name: Run Tests
    uses: kevin07696/deployment-workflows/.github/workflows/go-test.yml@main
    with:
      go-version: '1.24'

  build:
    name: Build Docker Image
    needs: test
    uses: kevin07696/deployment-workflows/.github/workflows/go-build-docker.yml@main
    with:
      service-name: kevin07696-payment-service

  # ===================================
  # STAGING DEPLOYMENT (Oracle Cloud)
  # ===================================

  deploy-staging:
    name: Deploy to Oracle Cloud Staging
    needs: build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Oracle Container Registry (OCIR)
        run: |
          echo "${{ secrets.OCIR_AUTH_TOKEN }}" | docker login ${{ secrets.OCIR_REGION }}.ocir.io \
            -u "${{ secrets.OCIR_USERNAME }}" \
            --password-stdin

      - name: Build and Push Docker Image to OCIR
        run: |
          IMAGE_TAG="${{ secrets.OCIR_REGION }}.ocir.io/${{ secrets.OCIR_TENANCY_NAMESPACE }}/payment-service:${{ github.sha }}"
          IMAGE_LATEST="${{ secrets.OCIR_REGION }}.ocir.io/${{ secrets.OCIR_TENANCY_NAMESPACE }}/payment-service:latest"

          echo "ðŸ—ï¸  Building Docker image..."
          docker build -t ${IMAGE_TAG} -t ${IMAGE_LATEST} .

          echo "ðŸ“¤ Pushing image to Oracle Container Registry..."
          docker push ${IMAGE_TAG}
          docker push ${IMAGE_LATEST}

          echo "âœ… Image pushed successfully"

      - name: Deploy to Oracle Compute Instance
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ORACLE_CLOUD_HOST }}
          username: ubuntu
          key: ${{ secrets.ORACLE_CLOUD_SSH_KEY }}
          script: |
            echo "ðŸ” Logging into Oracle Container Registry..."
            echo "${{ secrets.OCIR_AUTH_TOKEN }}" | docker login ${{ secrets.OCIR_REGION }}.ocir.io \
              -u "${{ secrets.OCIR_USERNAME }}" \
              --password-stdin

            echo "ðŸ“¥ Pulling latest Docker image..."
            docker pull ${{ secrets.OCIR_REGION }}.ocir.io/${{ secrets.OCIR_TENANCY_NAMESPACE }}/payment-service:latest

            echo "ðŸ›‘ Stopping existing container..."
            docker-compose -f ~/payment-service/docker-compose.yml down || true

            echo "ðŸš€ Starting new container..."
            cd ~/payment-service
            docker-compose up -d

            echo "â³ Waiting for health check..."
            sleep 10

            echo "ðŸ¥ Checking health..."
            curl -f http://localhost:8081/cron/health || exit 1

            echo "âœ… Deployment successful!"

      - name: Verify Deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          sleep 5
          curl -f http://${{ secrets.ORACLE_CLOUD_HOST }}:8081/cron/health

          echo "âœ… Staging deployment verified"
          echo "ðŸ“ Staging URL: http://${{ secrets.ORACLE_CLOUD_HOST }}:8081"

  migrate-production:
    name: Run Database Migrations (Production)
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install Goose
        run: go install github.com/pressly/goose/v3/cmd/goose@latest

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SQL Proxy
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
          ./cloud_sql_proxy -instances=${{ secrets.GCP_DB_INSTANCE_CONNECTION_NAME }}=tcp:5432 &
          sleep 5

      - name: Run migrations on Cloud SQL
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_USER: ${{ secrets.GCP_DB_USER }}
          DB_PASSWORD: ${{ secrets.GCP_DB_PASSWORD }}
          DB_NAME: ${{ secrets.GCP_DB_NAME }}
        run: |
          echo "ðŸ”„ Starting migrations for production database..."

          # Build connection string
          DATABASE_URL="postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=disable"

          # Run migrations
          goose -dir migrations postgres "$DATABASE_URL" up

          echo "âœ… Production migrations completed successfully"

  deploy-production:
    name: Deploy to Google Cloud Run
    needs: migrate-production
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push Docker Image
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          IMAGE_NAME: payment-service
        run: |
          echo "ðŸ”¨ Building Docker image..."

          IMAGE_TAG="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/payment-service/${IMAGE_NAME}:${GITHUB_SHA}"
          IMAGE_LATEST="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/payment-service/${IMAGE_NAME}:latest"

          docker build -t ${IMAGE_TAG} -t ${IMAGE_LATEST} .

          echo "ðŸ“¤ Pushing to Artifact Registry..."
          docker push ${IMAGE_TAG}
          docker push ${IMAGE_LATEST}

          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Deploy to Cloud Run
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          SERVICE_NAME: payment-service
        run: |
          echo "ðŸš€ Deploying to Cloud Run..."

          gcloud run deploy ${SERVICE_NAME} \
            --image ${{ env.IMAGE_TAG }} \
            --region ${GCP_REGION} \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --set-env-vars "PORT=8080,HTTP_PORT=8081,ENVIRONMENT=production,DB_SSL_MODE=require" \
            --set-env-vars "EPX_BASE_URL=https://secure.epxnow.com,EPX_TIMEOUT=30" \
            --set-env-vars "EPX_CUST_NBR=${{ secrets.EPX_CUST_NBR_PRODUCTION }}" \
            --set-env-vars "EPX_MERCH_NBR=${{ secrets.EPX_MERCH_NBR_PRODUCTION }}" \
            --set-env-vars "EPX_DBA_NBR=${{ secrets.EPX_DBA_NBR_PRODUCTION }}" \
            --set-env-vars "EPX_TERMINAL_NBR=${{ secrets.EPX_TERMINAL_NBR_PRODUCTION }}" \
            --set-env-vars "EPX_MAC=${{ secrets.EPX_MAC_PRODUCTION }}" \
            --set-env-vars "NORTH_API_URL=https://api.north.com,NORTH_TIMEOUT=30" \
            --set-env-vars "CALLBACK_BASE_URL=${{ secrets.CALLBACK_BASE_URL_PRODUCTION }}" \
            --set-env-vars "CRON_SECRET=${{ secrets.CRON_SECRET_PRODUCTION }},LOG_LEVEL=info" \
            --set-env-vars "DATABASE_URL=${{ secrets.GCP_DATABASE_URL }}" \
            --set-cloudsql-instances ${{ secrets.GCP_DB_INSTANCE_CONNECTION_NAME }} \
            --cpu 1 \
            --memory 512Mi \
            --min-instances 0 \
            --max-instances 10 \
            --timeout 300 \
            --concurrency 80

          echo "âœ… Production deployment completed successfully"

      - name: Get Service URL
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          SERVICE_NAME: payment-service
        run: |
          echo "ðŸ“ Getting Cloud Run service URL..."
          SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} \
            --region ${GCP_REGION} \
            --format 'value(status.url)')

          echo "Production URL: $SERVICE_URL"
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
