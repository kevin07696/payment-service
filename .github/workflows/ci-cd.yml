name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  # ===== STEP 1: UNIT TESTS =====
  unit-tests:
    name: 1. Unit Tests
    uses: kevin07696/deployment-workflows/.github/workflows/go-test.yml@main
    with:
      go-version: '1.24'

  # ===== STEP 2: BUILD =====
  build-docker-image:
    name: 2. Build Docker Image
    needs: unit-tests
    uses: kevin07696/deployment-workflows/.github/workflows/go-build-docker.yml@main
    with:
      service-name: payment-service

  # ===== STAGING DEPLOYMENT PIPELINE (develop branch only) =====
  #
  # LIFECYCLE:
  # - develop push â†’ provision infrastructure â†’ migrate DB â†’ deploy app â†’ test
  # - If any step fails â†’ auto-cleanup to free quota
  # - If succeeds â†’ keep running for debugging until next deploy
  #
  ensure-staging-infrastructure:
    name: Provision Staging Infrastructure (DB + Compute)
    needs: build-docker-image
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    uses: kevin07696/deployment-workflows/.github/workflows/infrastructure-lifecycle.yml@main
    secrets: inherit
    with:
      action: create
      environment: staging
  #
  # ===== STEP 3: DATABASE MIGRATIONS + STEP 4: DEPLOY APPLICATION =====
  # Note: Migrations and deployment are atomic - both succeed or both fail together
  # This ensures database schema and application code stay synchronized
  deploy-staging:
    name: 3. Database Migrations + 4. Deploy Application
    needs: ensure-staging-infrastructure
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    uses: kevin07696/deployment-workflows/.github/workflows/deploy-oracle-staging.yml@19b3eee
    secrets: inherit
    with:
      service-name: payment-service
      oracle-cloud-host: ${{ needs.ensure-staging-infrastructure.outputs.oracle_cloud_host }}
      db-host: ${{ needs.ensure-staging-infrastructure.outputs.db_host }}
      db-port: ${{ needs.ensure-staging-infrastructure.outputs.db_port }}
      db-service-name: ${{ needs.ensure-staging-infrastructure.outputs.db_service_name }}
      db-user: ${{ needs.ensure-staging-infrastructure.outputs.db_user }}
  #
  # ===== STEP 5: INTEGRATION TESTS =====
  integration-tests:
    name: 5. Integration Tests
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  #
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
  #
      - name: Wait for service to be ready
        run: |
          echo "â³ Waiting for service to be ready..."
          for i in {1..30}; do
            if curl -f -s "http://${{ needs.ensure-staging-infrastructure.outputs.oracle_cloud_host }}:8081/cron/health" > /dev/null 2>&1; then
              echo "âœ… Service is ready!"
              exit 0
            fi
            echo "Attempt $i/30 failed, retrying in 10s..."
            sleep 10
          done
          echo "âŒ Service did not become ready in time"
          exit 1
  #
      - name: Run integration tests
        env:
          SERVICE_URL: http://${{ needs.ensure-staging-infrastructure.outputs.oracle_cloud_host }}
          EPX_MAC_STAGING: ${{ secrets.EPX_MAC_STAGING }}
          EPX_CUST_NBR: ${{ secrets.EPX_CUST_NBR }}
          EPX_MERCH_NBR: ${{ secrets.EPX_MERCH_NBR }}
          EPX_DBA_NBR: ${{ secrets.EPX_DBA_NBR }}
          EPX_TERMINAL_NBR: ${{ secrets.EPX_TERMINAL_NBR }}
        run: |
          echo "ðŸ§ª Running integration tests against deployed service..."
          go test ./tests/integration/... -v -tags=integration -timeout=15m
  #
      - name: Integration test results
        if: always()
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **All integration tests passed!**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Staging environment kept running for continued testing**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Integration tests failed - production deployment blocked**" >> $GITHUB_STEP_SUMMARY
          fi
  #
  # ===== CLEANUP ON FAILURE (prevent dangling resources) =====
  cleanup-staging-on-failure:
    name: Cleanup Staging on Failure
    needs: [ensure-staging-infrastructure, deploy-staging, integration-tests]
    if: |
      always() &&
      github.ref == 'refs/heads/develop' &&
      github.event_name == 'push' &&
      (needs.ensure-staging-infrastructure.result == 'failure' ||
       needs.deploy-staging.result == 'failure' ||
       needs.integration-tests.result == 'failure')
    uses: kevin07696/deployment-workflows/.github/workflows/infrastructure-lifecycle.yml@main
    secrets: inherit
    with:
      action: destroy
      environment: staging
  #
  # ===== PRODUCTION DEPLOYMENT (main branch) =====
  deploy-production:
    name: Deploy to Production
    needs: [build-docker-image]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production
        run: |
          echo "ðŸš€ Production deployment placeholder"
          echo "TODO: Implement production deployment"
          # This will be replaced with actual production deployment workflow
          echo "## Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Placeholder" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Production deployment not yet implemented" >> $GITHUB_STEP_SUMMARY
  #
  production-smoke-tests:
    name: Production Smoke Tests
    needs: [deploy-production]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  #
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
  #
      - name: Health check
        run: |
          echo "ðŸ” Running production smoke tests..."
          echo "TODO: Replace with actual production URL"
          # PRODUCTION_URL="https://payment-service.example.com"
          # if ! curl -f -s "$PRODUCTION_URL/health" > /dev/null 2>&1; then
          #   echo "âŒ Health check failed!"
          #   exit 1
          # fi
          echo "âœ… Smoke tests placeholder passed"
  #
      - name: Smoke test results
        if: always()
        run: |
          echo "## Production Smoke Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Production deployment verified!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Production smoke tests failed - immediate rollback required!**" >> $GITHUB_STEP_SUMMARY
          fi
  #
  cleanup-staging-after-production:
    name: Cleanup Staging Infrastructure
    needs: [production-smoke-tests]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: kevin07696/deployment-workflows/.github/workflows/infrastructure-lifecycle.yml@main
    secrets: inherit
    with:
      action: destroy
      environment: staging
