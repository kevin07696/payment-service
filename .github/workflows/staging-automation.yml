name: Staging Automation

on:
  push:
    branches:
      - develop
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: read

jobs:
  # Auto-create staging when pushing to develop (if it doesn't exist)
  auto-create-staging:
    name: Auto-create Staging
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    uses: kevin07696/deployment-workflows/.github/workflows/infrastructure-lifecycle.yml@main
    with:
      action: create
      environment: staging
      terraform-directory: terraform
    secrets:
      OCI_USER_OCID: ${{ secrets.OCI_USER_OCID }}
      OCI_TENANCY_OCID: ${{ secrets.OCI_TENANCY_OCID }}
      OCI_COMPARTMENT_OCID: ${{ secrets.OCI_COMPARTMENT_OCID }}
      OCI_REGION: ${{ secrets.OCI_REGION }}
      OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_PRIVATE_KEY: ${{ secrets.OCI_PRIVATE_KEY }}
      ORACLE_DB_ADMIN_PASSWORD: ${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}
      ORACLE_DB_PASSWORD: ${{ secrets.ORACLE_DB_PASSWORD }}
      EPX_MAC_STAGING: ${{ secrets.EPX_MAC_STAGING }}
      CRON_SECRET_STAGING: ${{ secrets.CRON_SECRET_STAGING }}
      SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}

  # Auto-destroy staging after successful production deployment
  auto-destroy-staging:
    name: Auto-destroy Staging
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main' &&
      github.event_name == 'workflow_run'
    uses: kevin07696/deployment-workflows/.github/workflows/infrastructure-lifecycle.yml@main
    with:
      action: destroy
      environment: staging
      terraform-directory: terraform
    secrets:
      OCI_USER_OCID: ${{ secrets.OCI_USER_OCID }}
      OCI_TENANCY_OCID: ${{ secrets.OCI_TENANCY_OCID }}
      OCI_COMPARTMENT_OCID: ${{ secrets.OCI_COMPARTMENT_OCID }}
      OCI_REGION: ${{ secrets.OCI_REGION }}
      OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_PRIVATE_KEY: ${{ secrets.OCI_PRIVATE_KEY }}
      ORACLE_DB_ADMIN_PASSWORD: ${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}
      ORACLE_DB_PASSWORD: ${{ secrets.ORACLE_DB_PASSWORD }}
      EPX_MAC_STAGING: ${{ secrets.EPX_MAC_STAGING }}
      CRON_SECRET_STAGING: ${{ secrets.CRON_SECRET_STAGING }}
      SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
